<!DOCTYPE html>
<html>
<head>
<style>
table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #dddddd;
}
</style>
</head>
<body>

<h2>Conix Demo: Edge Resource Manager</h2>

<h3 id='framework'></h3>

<form action="/start">
    <input type="submit" value="Start Tasks"/>
</form>
<br/>
<form action="/stop">
    <input type="submit" value="Stop Tasks"/>
</form>

<h3 id='numtasks'></h3>

<p id='tasks'></p>

<h3 id='numagents'></h3>

<p id='agents'></p>

<h3 id='appoutput'></h3>
<div id='predictions'>
</div>

<script>
function loadTasks(){
  var xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = function () {
    if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
      var resp = JSON.parse(xmlHttp.responseText);
      if(resp.error) {
        document.getElementById('tasks').innerHTML = resp.error.toString();
      } else {
        var tableHTML = "<table><tr><th>Task ID</th><th>Name</th><th>Agent Assigned</th><th>Framework</th><th>Type</th><th>Image</th><th>State</th></tr>"
        var cnt = 0;
        for(var i =0; i<resp.length;i++) {
          var task = resp[i];
          if (task.state != "KILLED") {
            tableHTML += `<tr><td>${task.taskId}</td><td>${task.name}</td><td>${task.agentId}</td><td>${task.framework.name}</td><td>${task.container.type}</td><td>${task.container.docker ? task.container.docker.image : ""}</td><td>${task.state}</td></tr>`
            cnt += 1
          }
        }
        tableHTML += "</table>"
        document.getElementById('tasks').innerHTML = tableHTML
        document.getElementById('numtasks').innerHTML = `${cnt} Tasks`
      }
    } 
  }
  xmlHttp.open("GET", '/tasks', true);
  xmlHttp.send(null);
}
loadTasks();

function loadPredictions(){
  var xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = function () {
    if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
      var resp = JSON.parse(xmlHttp.responseText);
      if(resp.error) {
        document.getElementById('predictions').innerHTML = ''
      	document.getElementById('appoutput').innerHTML = ''
      } else if(resp.length < 0) {
      	document.getElementById('appoutput').innerHTML = 'Latest Camera Frame'
	document.getElementById('predictions').innerHTML = 'not ready yet'
      } else {
	document.getElementById('appoutput').innerHTML = 'Latest Camera Frame'
        var tableHTML = "<table><tr><th>Prediction</th><th>Confidence</th></tr>"
        var cnt = 0;
        for(var i =0; i<resp[0].objects.length;i++) {
          var prediction = resp[0].objects[i];
            tableHTML += `<tr><td>${prediction.name}</td><td>${prediction.confidence}</td></tr>`
        }
        tableHTML += "</table>"
        document.getElementById('predictions').innerHTML = resp[0].objects.length > 0 ? tableHTML : ''
        document.getElementById('predictions').innerHTML += '<img src="http://conixdb.com:3003/predictions" alt="Latest image" height="300">'
      }
    } 
  }
  xmlHttp.open("GET", '/predictions', true);
  xmlHttp.send(null);
}
loadPredictions();

function loadFramework() {
  var xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = function () {
    if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
      var resp = JSON.parse(xmlHttp.responseText);
      if(resp.error) {
        document.getElementById('framework').innerHTML = resp.error.toString();
      } else {
        document.getElementById('framework').innerHTML = `Framework: ${resp.framework.name}`
      }
    } 
  }
  xmlHttp.open("GET", '/framework', true);
  xmlHttp.send(null);
}
loadFramework();

function loadAgents() {
  var xmlHttp = new XMLHttpRequest();
  xmlHttp.onreadystatechange = function () {
    if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
      var resp = JSON.parse(xmlHttp.responseText);
      if(resp.error) {
        document.getElementById('agents').innerHTML = resp.error.toString();
      } else {
        var tableHTML = "<table><tr><th>Agent ID</th><th>Name</th><th>Last Ping</th></tr>"
        for(var i =0; i<resp.length;i++) {
          var agent = resp[i];
          tableHTML += `<tr><td>${agent.id}</td><td>${agent.name}</td><td>${agent.lastPing}</td></tr>`
        }
        tableHTML += "</table>"
        document.getElementById('agents').innerHTML = tableHTML
        document.getElementById('numagents').innerHTML = `${resp.length} Agents`
      }
    } 
  }
  xmlHttp.open("GET", '/agents', true);
  xmlHttp.send(null);
}
loadAgents();
</script>

</body>
</html>

